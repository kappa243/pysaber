import numpy as np

from pysaber.poly import gen_matrix, gen_secret, matrix_mul
from pysaber.rng import randombytes
from pysaber.saber_params import (SABER_L, SABER_N, SABER_NOISE_SEEDBYTES,
                                  SABER_SEEDBYTES)
from tests.common import rng_init


def test_gen_matrix():

    rng_init()

    A = np.zeros((SABER_L, SABER_L, SABER_N), dtype=np.uint16)
    seed_A = bytearray(SABER_SEEDBYTES)

    randombytes(seed_A, SABER_SEEDBYTES)

    gen_matrix(A, seed_A)

    result = ""
    for i in range(SABER_L):
        for j in range(SABER_L):
            for k in range(SABER_N):
                result += f"{A[i][j][k]:02x}"

    assert (
        result
        == "80718049e91ccd5eb512134d1c5f199e4191fa713051aac19551df35f913c6ab24cbd1f8a7175817e1edbfd781615e8e4e1dd31867ccc10623c1d12eedd328834a412bc1a191432c4ed17105c1905e04159711501ad816cf8b819a961816241f8710b71a11176e127f159f36957c5491c05ba2b6d1165192f8444a6a321bfdbba1211193aedb1cadafbb167af38a4f4a09d191b61166aad61bf084d147d171e1d535cd10f41ef312b516f918cd38910512cd3ad46c1aa4cd569617e1175b15fa14a5be21100320a2a7fa7c213c31242164dc9fff59cf1c3b9cf8ea1d8d134b6eb1efa18691dfc9241c391c9f128e17248b01418bab13d710c2e0131910797552cbceb2f1a251c4811231c9b15e910fa6f015a11aab13f713b23391e4a16eb174216936c8da419146de184f74a16a51664ed019d4d7ad9b15d81d72f6a97b2056beb16671b3518a0121115c269213a16b31561179c671117f15e11a881b741031bd2176e1b9682817881002101d19544b976918a31c1b1440aca1e513a2ef5e74a2f1ac8c7a1f2e161105e197215c54de17dd9234f31e121483c8d1d801dbb1b8412001da3154a70ff5b16b82ca49875d198c1659115015c15da4db6cb1c794ee1fd416f195a1ad210311f8e9a7176911ce12982475957e2128b0c1dbf195a180637fd36188317bc1566bc212731d9d1ee018de16fa97a1a91687140c1a6687b8921ce815d196b3fd1e274fb6e1168019bc30217f1524b3a16eb11aed4f144dba1c199e6141a1bca1be912dd1bbc1a0597b1fcbcd116e81281a44f79641f2914046962f15af3b116f3da14d614421e28591e8cba9e6a1793a1215e01d921ab31ed2763f34481d3b56b1e035531bb4e348e01e1c1c4e1dc5150f7a11fa5f931273aa21fa1c1d1df3ef115fca1a4d216c0831eac9cc181f534805a957e3dd61ce31dcea1a103afe11f7a1de65c728f1326108149a1bd71953c121e08bcb1043cb9925b661e7c1f251cadcc7f6517d016e14cc5d41a0f1a7612f11c726855aa12feeac15cc2221de721214ef7b56b85f61a1bc8141276114e19f71321260ff812181f1c4fb70790126210df19bc1ac21e03129010b5219dbf35416151ecf1b89b87132625815191c6814a313de7fa1d371669101565a1b913a4e561b3a1b3e153e13626ab1832175545324a6331b3dbb61e1d2bb1dd56cfe51696b671d0ba8f119f74f177b98e1ad819e662c1f35184f3577791b361689d928a41dacadf784184011a410cee971905f3609a07b06c30e8cbd21de8141d176742e1bbfcf41f5f19e9bae267dd6117febd1e72aac95122413a86fd126d45113e890e1c992ad1ca81be71237572a7b102611ba499162117d113308b8136495639816b5b8594f9ed21a919cc2aa58611a598a1008e3ecfd144e8d65cb18e7b8c18701df21209142257916f9a1a91917ba9be1b6e106ee6146f1d42149118d9c44e0c8fbaa21eb26f0b1184b6b7fdf1c4b1eb210921f0014427c17f9139817161feb121a189f1a6515ca654154a5311c52881af11e22905d8b1be280e152119199671c85c301d5613e6c3efd11d66d8bf2c1f517f1400d0511bf1b31144eb25beb0d6c713da88d19245711901108b1d47161a13e213051a82139b13cb409b7e100b2c775c1a5b19541985f01f8819516d9a2d185e7c3f2b6e1a4710ef1b91fe613ff58f14292fb96a92213d8157ec631a1617821989bd5d32163f7a31c813bad51fa3112febe118a14c5ed6bae59019e0a6b3111cc8106a1bfd2571ecd53d9ee10eade8169110565deab1cfd1b5357b142cdb89b015ba12707a0131ff3612e2198f1aab414122f1010d954961bfe9f1c6acaa110812c10be117e419c412452151722987418640178188e1ea3152d5101dfa1fef1739ebfc43e3f1ab3a7484f44214ca105981411df683a1f24ab61006b2b1540f5027cbe9df41a8313b7e8a14a6152516652d71b181dc8ca811edf8e15ed1b8f1edd1b0585ea5798719b67311fc3f4a18f74421ede1e8a633d1342dfc1e7a1f09117f182a1db35f91ad91d131b5a1bb514261f75a408116e8b71f2b8d36f617911b1a4cc13ac19a4142eb181509a8d19cd1c04175f1539e3046c1c661ef6185619e399a4fc60b5067e21672a4a82112195a17f0bf21cb2f6efe25ac13cf19075f7e61fde1ede18bc111b1a37361fbb58a1d64ade7e714c2d2d7d1122a26e4ad4a2901d621258ab19cebecc472ef17e9a03134b1b92f9b4c607125f110e161d7b176a1d481baa14e010529e71510139e19921c11925a0e174ba6b192039d1d86b8317ea1d6117ebe3814e414ee19a4131a1b2c1358d2f8d2ec38c19bd1a0b1f51edd196450178c1c22fd08547ffeeb4141f15c7422172215781dbaeb119d5140616b713ca542184b82f16bec915e49e01a3e15c81f814b942616b511301cfe16c4150716851893a881ee11d85144d1cdf163e5f614fe1528150e19dc1f857d2836d750c126811414589b65a8a38166fa3c1781e06ba313c718a1153fd8a1ee01e8c2d05ba11004d11e2cb737fee231dbba97ef5e02d4d1e53936aa14cb40f1ed561f9f26da7851e0384c1d2c134219d1d02faa15d163113216a71cb01a4d311939157619431d3314351da44027061c251aa0ceca2516b1cfe1b2c123616b21d671bc52ee9571933150d89814cc1158e55cd2cf7f7c4fd30e391f21651948100bc5d19692e21240cb1d7b18e83112c185d36810bf21e23214ef1adbf322c4e5f1578173ad50b3f1dfd2a92ea5734e18351fe71c031b35532188116df1be6112b18de79fd121bafbed82e193ba1b18671a123551f14b5107b1cbc30916b51778c4a1412f3e78a4f1c8816eabbf4d477813443e9d60cfce271aa3bfa161b1a9e1e461600680a4f1ddd9df9a6ced501306dd717e21e82f6d13fef5716bdb7fd0d9b685566119f19991b2b33f163b1ac7b3a1d2f7061cebcd110291b31d11c9143f319133d1844d2c0f5d3cb41a7b167d7fb20615631b1e7bb1727a6431f1692150b13543441080f89158918fd17ff24915e6d9718d411122131e6116ddaad1e969c487e1232129ecf12f910a51f719c940e1a0b1225c9773be715cc3c6148111a3e6a672121a9f511019fa6aa168f785ea91c7a16df14ad12fb54f1ae7a3e14d137fda0143910c5c631599866c36aa65ded91d5d14f7c8a19631f75e6f1476352167e112450dcd019d61c0cbdb12a8da819161d11ae6400180c18e21f5f1c7a4841e14500b76b9110451331da9106b1cd9141f38d93a14f9113e8d61e54a01fe11cb91b7d187f1260ef9ca23046601dab186512ae45f63b15b016a97901eb988815c0e512321e30e441567180e123eb0917131c5710e917bb1f413e171f1ce67751ed967910044f815fd1da0120fb1cdaf6e5d068db1acf3933a1104687e190216d01ac33b71c2918912991fec17951a6f1bfc1cac1cce1d1c1640165a1924efb1d04e721f88160d1b121de6a018e418bd19f91dd61dd071f420401d57dbee0a1eae14bae6624139a96ec5f16051816a0a37c7951fd7159710621a4911e39e196a1201122811f61ed21a381500138a6b51864b111684197e96d1fb768c10ac1270166d144f1e7e941efc1c2de3112f511e31118199351215a916db61e15a13f61fcbb91db55991bdd19071ba2775178b14121cc11eed1420bcb17f0165d19a3e941ed1721621cb911392ca1d60b7b9fd1ac11dc71ee91e18182563113de37590e1806bbd1b7910227753fd190019f844377d51810d91cea13431896184183b11b658529e60818a737109d102c1608122b19641ec51fbfb55120914702e06001f82177013cd19df1d131633131fdcefd21afe1f18c2057a58c98f23c1c7a12e316a410a6ad7d7912d515482dcdd713f52e415556cb15b2a3f1e241c461028102875e332097d1de417ad4a01df4ab85dc3f946510c16d7151a58013b2173ec489d11f4ca993ef1875d49ebfd81d451ca71fdf16c1ab21e13051bdf4e6a8610331ac319e73f1cb19b0f0a1821f0d2772a0169d1177139517cd18086791e57d1a146cea64702a41253a03ee017d83611094bdbe6e1467cb21cfd8d961a2fad725f31abb6131f8dcdbe5683f1da513c9122f199a174e14211ac2cda5c4ba12f0e92131922265db7a211ce1c842b922522122c1bd1e8a1340195716651f73f87169aa4ffb1195ad1c21112211e2f1c0f2821c96251c7311e518c1179125167565116f6e00162d1b2513771c1721c1b31ce51632376d46ecd17c1622134b1407115b1ae016a4ab9c6191f122a1bf715851bcf14e110be13bb14031ad8b661f221e75178817f376d15a21fb45c710a918731f46cc49431721725b771442b0e1d6b1d1a19fba3179213f18b65361f471fd61421411e4f101a13ee9701324398189e1b5612dc132a7092e50e1380147f1fee3938a814c17fd16834ee13e69aadfa23a15071b1816a3172ee4f51717fba4780a5d0308d6120342c14101b5b11ff1e421e19151a29d5e1d2a3d151c1eb619ab87f1bf013451404d191e7a181b196f19375cc4d31e6cbde1b9f18767ee1ed918566d70015559ef1bee5081c5017201d02f099bb59cc02380195b1d475f1d16b64e6eb100b1cdb2181f0a501158c1c7e169f1fedf921ddf1e7c11891d31628db5cd21e201c0c13e3503f9d1fc3ac85be4408fb70e9c350e12c53a31c6ae777161e93154b6d19481f6a1dcc1b110e3412599e499f18b31bf11dac18a71bd95e02b51a1313c6392af5ef7170f1ec419d116cd180d17661191618fd9f471223ed71384e236331a191f23195f19306d0189741c7fe14e91ec71614f29a1317e56501af4dd21ee62cb16f176164eaeed436b01fc616c3c741ff780772ae457bd42615db1c93cc2841711f3a9f1a2a5ddd9b921bbc52a1c349054dc2d91dfefd4fca1d3b132b1b45b325733d1b1c46813c4e46cc9784d8d1c888211accd3a1a7a19b0121d1c955741f5a135c1f78fd31a3c5ededb9b41d4d136115da902d3b17041dd25c115782f9c71bc713cabcc1947fa1f5b1fc9ffcc2751cd9d12dd57db2b1838604b4919de947e2415e3131b2d71a6a191abc92b117a611d81090180e186d16831501e7477582315c7f74e1413c3924c2ff0e13be17a0194bbf51b4a17c44b61047162e10b145f10e416e8d791ca11250a067b95431def15ec13f1e4cd715401b9f1861c65fd31c9ca9e178f704eca1f63e15137902eff7fadb6c7a34e129e129c18a910a7cf2ef71ca61436136616cddc4af3d2d1467fbb9461aacdd2441c0917f5abf1f2f1de696a7a817171fec1a391bae856156119f34521bdb156935e10411a59175ba8a9043c89ad3117d91c421a529a415113e5159ad47ff8741a09121173653d125d849113115217211aa6c03d7f1cdcaeb1f13e379593913426d8cde9488ca5dad9f1813b59f7813811cd0624881c29191c15ad1e631cf8184dfcc4db4bf19d1ed1172612aab101e9edb515161a455cf13617e1e6ce02134a1e53e7c8cab196d1533e8a86912c189918c2f291d1074e15d81ac397615ef19ed15aa194d1a2a5f0c801ca1dbc5e252d11fcadf18d91e48adf97ed8f1f851a911a0c1a5413bd3181fb1112b4498831a2aa4c9f118531430122f1bf510a01ffa15dab00122627f"
    )


def test_gen_secret():

    rng_init()

    s = np.zeros((SABER_L, SABER_N), dtype=np.uint16)
    seed_s = bytearray(SABER_NOISE_SEEDBYTES)

    randombytes(seed_s, SABER_NOISE_SEEDBYTES)

    gen_secret(s, seed_s)

    result = ""
    for i in range(SABER_L):
        for j in range(SABER_N):
            result += f"{s[i][j]:02x}"

    assert (
        result
        == "03000001010000010001fffffffefffe01000100ffff00000001fffdffff0203000000020003ffff01fffd0102fffefffe000201ffff0102010002fffe000101ffff01ffffffff0100000000020200fffdfffffffe0101ffff02fffffffe02ffff000101fffefffefffffffefffffffe01ffff00fffffffe010100ffff00ffff00020000fffd01ffff01fffdffff01010000010100010101ffff01ffff0200fffffffe010000ffff0000ffff0101010100ffff0101ffffffff00ffff000102ffff03ffffffff000000fffefffeffff0200fffeffff01020200fffd0101030200ffffffff00fffe00010101020200fffd0100ffff0101ffff03fffe000001ffff00fffffffffffe010000fffc00ffff0201fffffffe0001fffe0103fffe00ffffffff0002ffff0000fffffffd01010101000102020000ffff0100010000fffffffefffffffffffefffd00fffffffeffff0003ffff01fffdffff000101ffff00010100000200010200000201fffe0003ffffffffffff00ffff0300ffffffff010000fffe000100010202fffe00fffefffe00ffff0002000200fffe0100fffeffff000301000101fffe00fffc01fffffffffffefffffffe000100fffe00ffffffff020001ffff00010100010002fffdffff00000001fffe0000fffe0001000101fffffffd000002ffff0100ffff01fffe01ffffffff0300fffeffff01ffffffff000001010000ffff00ffff00fffffffffffe0000fffeffff0100ffffffff01fffffffe02ffffffff010101000002ffff0001fffd00fffe000200ffffffffffffffff01010000000001fffefffe0101fffe00fffffffe01ffff020001fffffffe01ffff01ffffffffffff0103ffff00ffff01ffff00fffefffdffff01ffff000001ffff01010001ffffffff0202fffe010201ffff00010301fffd02fffffffeffffffffffff020301010101020001fffffffffffd020100ffff0002fffe00fffefffe0001ffff010200fffe02fffe00ffff03fffffffffffe02ffff0101fffd020004010100fffffffffffffffffffe000201020102020101ffff0000fffefffffffe00ffffffff01000002fffeffffffff00ffff0301fffefffe0201ffff0300fffe01ffff0002020101fffffffdffff0000ffffffff02010100000000ffffffffffffffff03000102ffffffff0203000001010001fffe00fffe030101fffffffffffd000100fffffffe0000000102fffe0101ffff01fffe02020100020201fffe0000000002fffd03000000ffff00ffff010203fffffffeffffffff02ffffffffffffffff0100fffe0001ffff010101fffeffff03ffff00fffe0201ffffffff00ffff02ffff0101fffe0202fffc0002ffffffff0000fffffffd02fffd00ffff01fffd000101fffe0001fffd00ffff0202ffffffff01fffffffeffff00ffff0000fffffffdffffffff01fffe020203ffff01fffe010001fffefffffffffffeffff02fffe00ffff"
    )


def test_matrix_mul():

    rng_init()

    A = np.zeros((SABER_L, SABER_L, SABER_N), dtype=np.uint16)
    s = np.zeros((SABER_L, SABER_N), dtype=np.uint16)
    b = np.zeros((SABER_L, SABER_N), dtype=np.uint16)

    seed_A = bytearray(SABER_SEEDBYTES)
    seed_s = bytearray(SABER_NOISE_SEEDBYTES)

    randombytes(seed_A, SABER_SEEDBYTES)
    randombytes(seed_s, SABER_NOISE_SEEDBYTES)

    gen_matrix(A, seed_A)
    gen_secret(s, seed_s)

    matrix_mul(A, s, b, 1)

    result = ""
    for i in range(SABER_L):
        for j in range(SABER_N):
            result += f"{b[i][j]:02x}"

    assert (
        result
        == "c13f9e80d029a4bcf20c43633963fc103c78e1f4e8eb9625b364e5e74385395e2b73ca5632db71ca891587ce46c14b6f01fec75953e8341359e9d496b6328b6e6efed3a9e0f65c5607dc4956478e6e7f71cfc76b63daba60ab03c902a30fd54e8c0c4b9b178f6218520466a349a064bd5b755e847fd3f3055e83203cff64af53ac95e1cd18f505fe371e69bb3ec4fd270a3cb729f3260976432ddc428dd37257a1fcad766ca660230b81c62b7b7f84d50ea4df611758d19d2667e6645ea539ee8b70110737862969586f71af8c465d750b6f7de3f114211c05b9c785aff1822591cd4d2c9eabbe85aa56ed39fdc13e8d15a0bf921a5174753a779b75e72ef4662ccd31f82f0bc31639dfef66df5e77abc2a6214dba85d81219b5dab7bf2b13e3838103a2c92ac5ee899bc8c1dbfb6a755fa16bfedec6acb503f574aff14c8cf79f5d812a0c2c12ae6a1e85a4dfd970d24cb7f8ee82264ae00ea0c0b07536b3beae3005a4d1b3aeeae380dbb381a8c67e60deb8bd45e3687cc6ab63c96db441b36513967525fcf2e1727bf2cda6bfacb5e81bac42c96ad920fcedbd45d874ddc961941792fbe8b2dceb2931102d65c18006c9c1130933d5c2f902bf6e7eab25b35357c4cef338e3d4bce86a81499fe5ce857b6bd44b72c3f56cfb85868c33d135b135a5d45474c5d9e1b8a8b79fa65dfd005695914cd7dab4225b7175e6c0d4350e922d8af2d41e3f8dfd2ec6a6599b98593ebfe50541259a62a9d9eded80e3741054598bdcc5ee85221fa79e345b1510fb2f59e05716ea5b6914061229c400328fe2a762f5b270f35617144ba10cecb94ca75470c1294d5eaaa2c378c17118a77f3fdbec9021d6fe941ce4627ce4b43e1727ae652884bf9aae829ee53cb39582d1f6b951caad22787208f3829f813b381b2228c78c0e792103b2eefbe246ae3f5359c082644995f02f4108f4818914befabfd17f5950e358387eab4dc42349eca062399b39f4d8b8953d64ef6dceb2679eadf2c9612038f4c17849253a460c1e766027d3fb2743e9eb0bc3690ea689ea25c94e55ff8fea20a52c6e5867d98a2d42909d4971632a7be8fce2940d5282189fe94ae5ce124ba24e348ecba8231089afa255e2863edf282b45c9991e93ce1006e7e5a80a707d8047d7d0c5076bbfa0317d65da1a13f4a43a3576b782b682dcad51cd5a9af6425031fd53976b4095d4c7e7ecb18cd615bf5e1c661c459b1387e2adb487cfbfd1cf7ca637e12d95e9219c1679b28760e8741f3a9b96d779ee850d6f2453bc6223dda1dbabbe23549c5840420aa47ac370b26812f69c6c96ef0bae4d75d3c6576dd7f823f2df16d90f86ecb327cc65376a3e65fe5419380d1534789cddef24324a6081a2c65f23a17f95583d50a155ada20c413c4d646c203ac717a33962210e682a79abbacb95fbee7a967c7b9ac91718cc38e8f6f5e0f4fd3549154149b5a78ed7d819857ab9337f93098f29e5ebf3267bcd2c47f92fb70b562d5ec12bb3fddd34fd45f93d930a2341154e33db850e14e10101a69ea957c23e97163a451618a9f5ae71670db4c7ad3a270d59d6a8c092198abce6391cf97a155da033ca891552aae7f25256777ce39acc42e79822595f0536d8ca7230893b2861cf0db18df86bc9fcd68898c9977aade372666d585a2520117a9953d3cb586c2ccac2e9f92ceb6dc88268a11b490a7442f35c049900576237f07a1f1c70d389b2d408271fd8ef197eda984fc9563b479aa880db1aeaad71d943d4aed2ab7cd35a871c73bf4968e6c3c3a32f839d8b0eccd94702137e60acac04fe8f50b401179fb2ed020ef85d6310c178fd21157f38a80cf4f264ea985bcf9ec87ccdd5b1f4e5ea37de22fddcc99ad2f7b688c06d45b96e0fcb77b750e9cbed81b7ee7cc750faae132e0a3df7964373c3654a767146d86e7ef8ea6fdad58ca32d8a10618ee48011762b9e303de6447071c06db230e9df0eca56719f3efa122867f2541aff0cd67e7ad7a5fc9bb48b8bc71ae9cb2c730cdfbe38895c9ff9acfa68a90947fe89f7a2284379b19192e5bf023b4f171e5ea16649d4708d33f79ff2405e28a7c98a9c8d7c1b76e918599dd4175dbb9ad651b8"
    )
